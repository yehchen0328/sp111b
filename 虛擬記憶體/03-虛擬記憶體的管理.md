# 第三章：虛擬記憶體管理

## 3.1 虛擬記憶體管理的目標

虛擬記憶體管理的主要目標是通過有效地管理虛擬記憶體，最大限度地提高系統的性能和可用性。其主要目標包括：

1. 將應用程序使用的內存空間從實際可用的物理內存空間中分離出來，以滿足應用程序對內存空間大小的要求。

2. 最小化內存碎片，以允許更多的內存空間被有效地使用。

3. 最大化內存的利用率，以提高系統性能。

4. 在需要時，自動地將存儲在磁盤上的內存頁面讀取到實際可用的物理內存中，以保證應用程序的運行。

5. 保證系統的穩定性和可用性，避免因為內存不足而導致系統崩潰或應用程序運行失敗。

總的來說，虛擬記憶體管理的目標是通過將虛擬內存映射到實際可用的物理內存中，以提高系統的性能和可用性，同時保證應用程序的正常運行。

## 3.2 頁式記憶體管理

頁式記憶體管理是虛擬記憶體管理的一種常用算法，它將虛擬記憶體和實際可用的物理內存分成固定大小的頁，每個頁都有一個對應的頁框（或頁幀）在實際可用的物理內存中，當應用程序需要訪問某個虛擬地址時，操作系統會將對應的頁從磁盤中讀取到一個可用的頁框中，並將虛擬地址映射到實際可用的物理地址。

在頁式記憶體管理中，操作系統會維護一個頁表，用於將虛擬地址映射到實際可用的物理地址。每個頁表項目包含以下信息：

1. 該頁是否已被加載到物理內存中。

2. 該頁的虛擬地址和實際可用的物理地址之間的映射關係。

3. 該頁的存取權限（例如讀取權限或寫入權限）。

當應用程序需要訪問某個虛擬地址時，操作系統會首先根據虛擬地址的頁號找到對應的頁表項目，然後檢查該頁是否已經被加載到物理內存中。如果該頁已經在物理內存中，則直接將虛擬地址映射到實際可用的物理地址；如果該頁尚未被加載到物理內存中，則操作系統會從磁盤中讀取該頁，並將其放入一個可用的頁框中，然後更新頁表項目以反映該頁的新位置，最後再將虛擬地址映射到實際可用的物理地址。

## 3.3 段式記憶體管理

段式記憶體管理是一種在作業系統中管理記憶體的方法，它將記憶體區域分成多個段，每個段都有自己的大小、基址和限制。這種方法可以提供更加靈活的記憶體管理，使得不同的程式可以被載入到不同的記憶體段中，以減少彼此之間的干擾。

段式記憶體管理的基本思想是將程式的邏輯地址（即程式中使用的地址）分成兩部分，一部分是段號，另一部分是段內偏移量。在運行時，作業系統將段號轉換成實際的物理地址，然後加上段內偏移量，得到最終的實際物理地址。

儘管段式記憶體管理可以提供更加靈活的記憶體管理，但是它也帶來了一些問題，例如碎片化問題和段之間的重疊問題。為了解決這些問題，許多現代作業系統採用了更加高級的記憶體管理方法，如分頁式記憶體管理。

## 3.4 段頁式記憶體管理

段頁式記憶體管理是一種將段式記憶體管理和分頁式記憶體管理結合起來的方法。它的基本思想是將記憶體空間分成多個段，每個段再進一步分成多個固定大小的頁。這樣就可以同時利用段式記憶體管理和分頁式記憶體管理的優點。

在段頁式記憶體管理中，每個段都有一個段表，每個頁也有一個頁表。段表中包含了每個段的大小、基址和頁表的位置；頁表中則包含了每個頁的物理地址。

當程式要訪問記憶體時，它會提供一個邏輯地址，這個邏輯地址包含了段號和頁號。作業系統會首先根據段號找到對應的段表，然後再根據頁號找到對應的頁表，最終得到該頁的實際物理地址。如果找不到對應的頁表，就會觸發缺頁中斷，作業系統會根據一定的策略將該頁調入物理內存中。

段頁式記憶體管理能夠有效地解決碎片化和段之間的重疊等問題，同時也能夠提供更加靈活的記憶體管理，讓不同的程式可以在同一個記憶體空間中運行。但是它也需要較大的段表和頁表，並且在尋找物理地址時需要額外的運算，因此會帶來一定的性能開銷。

## 3.5 非連續分配

在作業系統中，非連續分配是一種記憶體管理方式，其中允許進程在內存中非連續地佔用多個區域，這與連續分配不同，連續分配要求進程佔用一個連續的內存區域。

常見的非連續分配方式有以下幾種：

1. 單一分配：在這種方式中，內存被劃分成多個大小不等的分區，每個進程只能佔用其中一個分區。這種方式適用於多個小型進程佔用內存的場景。

2. 固定分區分配：在這種方式中，內存被劃分成固定大小的分區，每個分區可以佔用一個進程，進程的大小必須小於或等於分區大小。這種方式適用於固定大小的進程佔用內存的場景。

3. 動態分區分配：在這種方式中，內存被分成一個或多個可用的分區，進程可以動態佔用和釋放這些分區。這種方式適用於大小不固定的進程佔用內存的場景。

非連續分配的優點是可以更好地利用內存空間，並且允許多個進程同時佔用內存。但是它也帶來了一些問題，例如外部碎片化和分配效率低下等問題，需要采取一些策略來解決這些問題。